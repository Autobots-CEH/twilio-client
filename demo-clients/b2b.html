<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>twilio-client Demo</title>

  <script src="../../platform/platform.js"></script>
  <script src="namesgenerator.js"></script>
  <link rel="import" href="../twilio-client.html">

  <link href="styles.css" type="text/css" rel="stylesheet" />

</head>
<body unresolved>

<twilio-client capabilityTokenUrl="/capability"></twilio-client>

<img src="imgs/logo.png" alt="logo" class="logo"/>

<div class="descriptionContainer">
  <h2>Browser-to-Browser</h2>
  <p>Demo presenting a possible browser to browser connection between two separate twilio clients. To test this demo, open two windows of the same page.</p>
  <p>Each page will generate its own unique client name. The name of this client is displayed below. On the right hand side, is a list of available clients.</p>
  <p>If any other client will be available, it will be presented in that list. Just click on the client name to make a connection to this client.</p>
  <p>To pick up a call, wait for an incoming connection information in the log message box, and press the 'Pick Up' button.</p>
  <p>To hand up a call, press the 'Hang Up' button.</p>
  <p>With twilio demo account, it is sometimes necessary to press 'Any Key', in order to continue with the call. There is a button for this as well.</p>

  <p>Client Name: <strong id="clientName"></strong></p>

</div>
<button class="call">
  Pick Up
</button>

<button class="hangup">
  Hang Up
</button>

<button class="anykey">
  Any Key
</button>

<div id="log">Loading pigeons...</div>

<ul id="people"/>

<script>
  var client = document.querySelector('twilio-client');
  var clientNameDiv = document.querySelector('#clientName');
  var logMessage = document.querySelector('#log');
  var peopleList = document.querySelector('#people');
  var clientName = Utils.NamesGenerator();

  clientNameDiv.innerText = clientName;
  client.clientName = clientName;
  client.auto = true;

  document.addEventListener('polymer-ready', function () {
    // Get reference to buttons.
    var pickUpButton = document.querySelector('.call');
    var hangUpButton = document.querySelector('.hangup');
    var anyKeyButton = document.querySelector('.anykey');

    // Attach actions to buttons.
    pickUpButton.onclick = client.acceptConnection;
    hangUpButton.onclick = client.hangUp;
    anyKeyButton.onclick = client.anyKey;

    // Set up event listeners for custom events.
    client.addEventListener('device-ready', function () {
      logMessage.innerText = "Ready";
    });

    client.addEventListener('device-error', function (e) {
      logMessage.innerText = "Error: " + e.detail.error.message;
    });

    client.addEventListener('device-connect', function () {
      logMessage.innerText = "Successfully established call";
    });

    client.addEventListener('device-disconnect', function () {
      logMessage.innerText = "Call ended";
    });

    client.addEventListener('device-incoming', function (e) {
      logMessage.innerText = "Incoming connection from " + e.detail.connection.parameters.From;
    });

    client.addEventListener('device-presence', function (e) {
      var pres = e.detail.presence;

      if(pres.available) {
        var newElement = document.createElement('li');
        newElement.id = pres.from;
        newElement.innerText = pres.from;
        newElement.onclick = function () {
          client.call(newElement.id);
        };
        peopleList.appendChild(newElement);
      } else {
        var elementToDelete = document.querySelector('#' + pres.from);

        if(elementToDelete) {
          elementToDelete.parentNode.removeChild(elementToDelete);
        }
      }
    });
  });
</script>
</body>
</html>
