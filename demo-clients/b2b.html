<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>twilio-client Demo</title>

  <script src="../../platform/platform.js"></script>
  <script src="namesgenerator.js"></script>
  <link rel="import" href="../twilio-client.html">

  <link href="styles.css" type="text/css" rel="stylesheet" />

</head>
<body unresolved>

<twilio-client capabilityTokenUrl="/capability"></twilio-client>

<h3>Client Name</h3>
<h4 id="clientName"></h4>

<button class="call" on-click="{{call}}">
  Call
</button>

<button class="hangup" on-click="{{hangUp}}">
  Hang Up
</button>

<button class="anykey" on-click="{{anyKey}}">
  Any Key
</button>

<input id="number" name="number" type="text"
       placeholder="Enter a phone number to call"/>

<div id="log">Loading pigeons...</div>

<ul id="people"/>

<script>
  var client = document.querySelector('twilio-client');
  var clientNameDiv = document.querySelector('#clientName');
  var logMessage = document.querySelector('#log');
  var peopleList = document.querySelector('#people');
  var clientName = Utils.NamesGenerator();

  clientNameDiv.innerText = clientName;
  client.clientName = clientName;
  client.auto = true;

  document.addEventListener('polymer-ready', function () {
    // Get reference to buttons.
    var callButton = document.querySelector('.call');
    var hangUpButton = document.querySelector('.hangup');
    var anyKeyButton = document.querySelector('.anykey');

    // Attach actions to buttons.
    callButton.onclick = function () {
      var number = document.querySelector('#number').value;
      client.call(number);
    };
    hangUpButton.onclick = client.hangUp;
    anyKeyButton.onclick = client.anyKey;

    // Set up event listeners for custom events.
    client.addEventListener('device-ready', function () {
      logMessage.innerText = "Ready";
    });

    client.addEventListener('device-error', function (e) {
      logMessage.innerText = "Error: " + e.detail.error.message;
    });

    client.addEventListener('device-connect', function () {
      logMessage.innerText = "Successfully established call";
    });

    client.addEventListener('device-disconnect', function () {
      logMessage.innerText = "Call ended";
    });

    client.addEventListener('device-incoming', function (e) {
      logMessage.innerText = "Incoming connection from " + e.detail.connection.parameters.From;
    });

    client.addEventListener('device-presence', function (e) {
      var pres = e.detail.presence;

      if(pres.available) {
        var newElement = document.createElement('li');
        newElement.id = pres.from;
        newElement.innerText = pres.from;
        peopleList.appendChild(newElement);
      } else {
        var elementToDelete = document.querySelector('#' + pres.from);

        if(elementToDelete) {
          elementToDelete.parentNode.removeChild(elementToDelete);
        }
      }
    });
  });
</script>
</body>
</html>
