<script src="../twilioclient-fixed/twilio.js"></script>
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../cachable-ajax/cachable-ajax.html">

<script src="../lodash/dist/lodash.min.js"></script>

<!--
Twilio client element, being able to perform outgoing calls, receive incoming calls,
and supports browser-to-browser calls.

##### Example

    <twilio-client
    capailityToken="54h54h7j8k8"
    capailityTokenUrl="<URL-TO-YOUR-TWILIO-APP>"
    number="=48123456789">
    clientName="someName"</twilio-client>

@element twilio-client
@blurb Twilio client element, being able to perform outgoing calls, receive incoming calls,
and supports browser-to-browser calls.
@status alpha
@homepage https://github.com/domderen/twilio-client
-->
<polymer-element name="twilio-client" attributes="capabilityToken capabilityTokenUrl number clientName">
  <template>
    <link rel="stylesheet" href="twilio-client.css"/>
    <ul>
      <template repeat="{{a in available}}">
        <li id="{{a.from}}">{{a.from}} - {{a.available}}</li>
      </template>
    </ul>

  </template>

  <script>
    (function () {

      var cachableAjax = document.createElement('cachable-ajax');
      var self;

      Polymer({
        /**
         * `capabilityToken` is a token generated by your server with proper capabilities.
         * This parameter can also accept a Promise which will return the capabilityToken, once resolved.
         *
         * @property capabilityToken
         * @type string
         * @default ''
         */
        capabilityToken: '',

        /**
         * `capabilityTokenUrl` is an address from where the token can be obtained. If provided, component will
         * send a GET request to a given Url, and expecting a HTTP response:
         * - With Content-Type: text/html,
         * - With http status code: 200,
         * - With capabilityToken written in response body, as a plain text.
         *
         * @property capabilityTokenUrl
         * @type string
         * @default ''
         */
        capabilityTokenUrl: '',

        /**
         * 'clientName' is a name that will identify this browser with your server side application.
         * If this value is provided, it will be used together with capabliltyTokenUrl as a parameter to the request,
         * defining for your server application, what name does this browser has, before generating a token.
         *
         * @attribute clientName
         * @type string
         * @default ''
         */
        clientName: '',

        /**
         * 'number' is the number to call for outgoing calls.
         *
         * @attribute number
         * @type string
         * @default ''
         */
        number: '',

        /**
         * 'available' is the array of people being currently available in the application.
         *
         * @attribute available
         * @type array
         * @default '[]'
         */
        available: [],

        /**
         * 'autoInit' If true, automatically performs component startup.
         *
         * @attribute autoInit
         * @type boolean
         * @default false
         */
        autoInit: false,

        ready: function () {
          cachableAjax.auto = false;
          self = this;

          if(self.autoInit) {
            self.init();
          }
        },

        init: function () {
          if (self.capabilityToken) {
            Promise.resolve().then(function () { return self.capabilityToken; }).then(self.setupClient);
          } else if (self.capabilityTokenUrl) {
            self.getToken().then(self.setupClient);
          } else {
            throw new Error('No configuration parameters provided. Please provide either "capabilityToken" or ' +
            'the "capabilityTokenUrl". For further details, please consult the documentation.');
          }
        },

        setupClient: function (capabilityToken) {
          Twilio.Device.setup(capabilityToken || self.capabilityToken);

          Twilio.Device.ready(function (device) {
            console.log('Ready');
          });

          Twilio.Device.error(function (error) {
            console.log('Error: ' + error.message);
          });

          Twilio.Device.connect(function (conn) {
            console.log('Successfully established call');
          });

          Twilio.Device.disconnect(function (conn) {
            console.log("Call ended");
          });

          Twilio.Device.incoming(function (conn) {
            console.log("Incoming connection from " + conn.parameters.From);
            // accept the incoming connection and start two-way audio
            conn.accept();
          });

          Twilio.Device.presence(function (pres) {
            var alreadyExists = _.find(self.available, function (av) {
              return av.from === pres.from;
            });

            if (alreadyExists) {
              alreadyExists.available = pres.available;
            }
            else {
              self.available.push(pres);
            }
          });
        },

        getToken: function () {
          cachableAjax.url = self.capabilityTokenUrl;

          if (self.clientName) {
            cachableAjax.params = {clientName: self.clientName};
          }

          return cachableAjax.go().then(function (token) {
            self.capabilityToken = token;
          }, function (err) {
            throw new Error('The request for capabilityTokenUrl has failed. Please confirm the correctness of the' +
            'url, and try again. If it still does not work, please check your server setup.\n' + err);
          });
        },

        isValidPhoneNumber: function (phone) {
          var regex = /^\+(?:[0-9] ?){6,14}[0-9]$/;

          return !!regex.test(phone);
        },

        /**
         * The `call` method performs the connection to the twilio device.
         *
         * @method call
         */
        call: function (number) {
          // get the phone number to connect the call to
          var params;

          if (self.isValidPhoneNumber(number || self.number)) {
            params = {"PhoneNumber": number || self.number};
          } else if (self.number) {
            params = {"ClientName": number || self.number};
          }

          Twilio.Device.connect(params);
        },

        /**
         * The `hangUp` method disconnects all connections to the twilio device.
         *
         * @method hangUp
         */
        hangUp: function () {
          Twilio.Device.disconnectAll();
        },

        /**
         * The `anyKey` method simulates pressing '1' on the keypad, to move forward with the messages.
         *
         * @method anyKey
         */
        anyKey: function () {
          var conn = Twilio.Device.activeConnection();
          if (conn) {
            conn.sendDigits('1');
          }
        }
      });
    })();

  </script>

</polymer-element>
