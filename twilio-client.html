<link rel="import" href="../polymer/polymer.html">
  <link rel="import" href="../cachable-ajax/cachable-ajax.html">

<!--
Twilio client element, being able to perform outgoing calls, receive incoming calls,
and supports browser-to-browser calls.

##### Example

    <twilio-client
    capailityToken="54h54h7j8k8"
    capailityTokenUrl="<URL-TO-YOUR-TWILIO-APP>"
    number="=48123456789">
    clientName="someName"</twilio-client>

@element twilio-client
@blurb Twilio client element, being able to perform outgoing calls, receive incoming calls,
and supports browser-to-browser calls.
@status alpha
@homepage https://github.com/domderen/twilio-client
-->
<polymer-element name="twilio-client" attributes="capabilityToken capabilityTokenUrl number clientName">
  <link href="http://static0.twilio.com/packages/quickstart/client.css"
        type="text/css" rel="stylesheet" />
  <template>

    <link rel="stylesheet" href="twilio-client.css"/>

    <input type="text" value="{{number}}"
           placeholder="Enter a phone number to call"/>

    <button class="call" on-click="{{call}}">
      Call
    </button>

    <button class="hangup" on-click="{{hangUp}}">
      Hang Up
    </button>

  </template>

  <script>
    (function () {

      var cachableAjax = document.createElement('cachable-ajax');

      Polymer({
        /**
         * `capabilityToken` is a token generated by your server with proper capabilities.
         *
         * @property capabilityToken
         * @type string
         * @default ''
         */
        capabilityToken: '',

        /**
         * `capabilityTokenUrl` is an address from where the token can be obtained. If provided, component will
         * send a GET request to a given Url, and expecting a HTTP response:
         * - With Content-Type: text/html,
         * - With http status code: 200,
         * - With capabilityToken written in response body, as a plain text.
         *
         * @property capabilityTokenUrl
         * @type string
         * @default ''
         */
        capabilityTokenUrl: '',

        /**
         * 'clientName' is a name that will identify this browser with your server side application.
         * If this value is provided, it will be used together with capabliltyTokenUrl as a parameter to the request,
         * defining for your server application, what name does this browser has, before generating a token.
         *
         * @attribute clientName
         * @type string
         * @default ''
         */
        clientName: '',

        /**
         * 'number' is the number to call for outgoing calls.
         *
         * @attribute number
         * @type string
         * @default ''
         */
        number: '',

        ready: function () {
          cachableAjax.auto = false;

          if(this.capabilityToken) {
            this.setupClient(this.capabilityToken);
          } else if(this.capabilityTokenUrl) {
            this.getToken().then(this.setupClient);
          } else {
            throw new Error('No configuration parameters provided. Please provide either "capabilityToken" or ' +
            'the "capabilityTokenUrl". For further details, please consult the documentation.');
          }
        },

        setupClient: function (capabilityToken) {
          Twilio.Device.setup(capabilityToken || this.capabilityToken);

          Twilio.Device.ready(function (device) {
            console.log('Ready');
          });

          Twilio.Device.error(function (error) {
            console.log('Error: ' + error.message);
          });

          Twilio.Device.connect(function (conn) {
            console.log('Successfully established call');
          });

          Twilio.Device.disconnect(function (conn) {
            console.log("Call ended");
          });

          Twilio.Device.incoming(function (conn) {
            console.log("Incoming connection from " + conn.parameters.From);
            // accept the incoming connection and start two-way audio
            conn.accept();
          });
        },

        getToken: function () {
          cachableAjax.url = this.capabilityTokenUrl;

          if(this.clientName) {
            cachableAjax.params = {ClientName: this.clientName};
          }

          return cachableAjax.go().then(function (token) {
            this.capabilityToken = token;
          }, function (err) {
            throw new Error('The request for capabilityTokenUrl has failed. Please confirm the correctness of the' +
            'url, and try again. If it still does not work, please check your server setup.\n' + err);
          });
        },

        /**
         * The `call` method performs the connection to the twilio device.
         *
         * @method call
         */
        call: function () {
          // get the phone number to connect the call to
          var params;

          if(this.number) {
            params = { "PhoneNumber": this.number };
          }

          Twilio.Device.connect(params);
        },

        /**
         * The `hangUp` method disconnects all connections to the twilio device.
         *
         * @method hangUp
         */
        hangUp: function () {
          Twilio.Device.disconnectAll();
        }
      });
    })();

  </script>

</polymer-element>
